---
title: "Figure Supp4"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE, message = FALSE, warning = FALSE, comment = NA)

freshr::freshr()
library(readxl)
library(janitor)
library(dplyr)
library(dplyr)
library(car)
library(sjPlot)
library(gridExtra)
library(knitr)
library(tidyverse)
library(ggbeeswarm)
library(ggthemes)
library(emmeans)
library(parameters)
library(bayestestR)
library(ggplot2)
library(ggsci)
library(tinytex)
library(extrafont)
library(ggpubr)
#list the Fonts in windows
#windowsFonts()
#set-theme for figure
theme_set (theme_classic(base_size = 10, base_family = "sans"))

##libraries for color
library(ggsci)
library(wesanderson)
#names(wes_palettes)
library(colorBlindness)
library(viridis)
#dependent function
library(here)
source (here("src", "Develop_Function_posthoc_20230219.R"))
```

```{r,echo = FALSE}
#Figure plotting function
plot_raw = function(var, data = df_lite, title = var,
                    y_breaks = c(1:6 * 0.5), 
                    y_limits = c(0, 2), 
                    legend_position = c(0.4, 0.5)) {
df_lite %>%
   select(f.age, sex, f.layer, var) %>%
   tidyr::unite("group", sex:f.layer, sep = "-", remove = FALSE) %>%
   ggplot(aes(x = f.age, y = get(var), color = group, group = group)) + 
   #ggbeeswarm::geom_beeswarm(dodge.width = 0.4, alpha = 0.3) +
   stat_summary(fun = "mean", geom = "line", linewidth = 0.4,
                position = position_dodge(width = 0.4)) +
   stat_summary(fun.data = "mean_cl_boot", size = 0.02, linewidth = 0.4, 
                 position = position_dodge(width = 0.4)) +
   ggtitle(title) +
   scale_y_continuous(breaks = y_breaks, limits = y_limits) +
   labs(x = "", y = "") + 
   theme( legend.text = element_text(color = "black", size  = "8"),
          legend.position = legend_position,
          legend.title = element_blank(),
          axis.text.x = element_text(color = "black", size = "8"),
          axis.line.x.bottom = element_line (linewidth = 1/4),
          axis.text.y = element_text(color = "black", size = "8"),
          axis.line.y = element_line(linewidth = 1/4), 
          axis.ticks.x = element_blank(),
          plot.background = element_blank(),
          plot.margin = unit(c(0,-0.15,0,0), 'cm')) + 
    ggsci::scale_color_locuszoom() -> p
return(p)
  
}
```



### Figure Supp 4A- Kmean_CovM -tCC for all pairs
```{r}
load (here("output","2024-01-11_SummaryDevAll_Kmean_CovM_Corr_in_outV2_20231204.RData"))
```

```{r,fig.width = 3, fig.asp =0.7 , echo=FALSE}
plot_raw("r_allpair_mean",
         y_breaks = c(1:10 * 0.2), y_limits = c(0, 1),
        legend_position = "right", title = "tCC - all pairs")
```

```{r}
report_main_effect("r_allpair_mean")
report_inter_age_sex_layer("r_allpair_mean")
```

### Figure Supp 4B- Kmean_CovM -tCC in - out subnetwork
```{r,echo=FALSE}
layer.label = c("Layer 2/3", "Layer 4")
names(layer.label) = c("2", "4")

sex.label = c("Female", "Male")
names(sex.label) = c("F", "M")

age.label = c("P11", "P13", "P15", "P18", "P21")
names(age.label) = c("11","13","15","18","21")

y_breaks = c(1:6 * 0.2)
y_limits = c(0, 1)
y_limits = "none"
legend_position = 'right'
```
 
```{r,fig.width = 8, fig.asp =0.4, echo=FALSE}

df_lite_fig = df_lite %>%
        select(subject_id, sex, f.layer, f.age,location,in_r_mean, out_r_mean)%>%
        drop_na(out_r_mean) %>%
        gather (condition,r_value, in_r_mean : out_r_mean,factor_key=TRUE) %>%
        tidyr::unite(col = "set", c("subject_id", "f.layer", "location"), remove = FALSE)%>%
        tidyr::unite(col ="sex_layer", c("sex", "f.layer"), remove = FALSE)
 
ggplot(df_lite_fig,
    aes(x = factor(condition, levels = c("in_r_mean","out_r_mean")),
           y = r_value)) +
    geom_line(data = df_lite_fig, 
              aes(group = set, color = sex_layer), alpha = 0.5, linewidth = 0.5) +
    #geom_beeswarm(alpha = 0.5) +
    scale_x_discrete(labels = c("in", "out")) +
    facet_wrap(~f.age,ncol = 5, labeller = labeller(f.age = age.label)) +
    labs(x = "", y = "") +
    theme(legend.position = legend_position,
          legend.title = element_blank(),
          legend.text = element_text(color = "black", size  = "10"),
          #panel.border = element_rect(color = "black", fill = NA, size = 0.5),
          panel.spacing = unit(0, "lines"),
          strip.background = element_blank(),
          #strip.background = element_rect(color = "black", linewidth = 1),
          #strip.placement = ("outside"),
          #strip.text = element_text(size = 10),
          axis.text.x = element_text(color = "black", size = "10"),
          axis.line.x.bottom = element_line (linewidth = 1/2),
          axis.text.y = element_text(color = "black", size = "10"),
          axis.line.y = element_line(linewidth = 1/2), 
          axis.ticks.x = element_blank(),
          plot.background = element_blank(),
          plot.margin = unit(c(0,0.5,1,0), 'cm'))+
          ggsci::scale_color_locuszoom()+
          annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf)

```






### Figure Supp 4C - neuronal number vs subnetwork number
```{r}
#import data
df = read_xlsx(
  here("data", "SummaryDevAll_Kmean_CovM_withCorr_Dist_20230113.xlsx"),
  sheet = "ForMultilevel")

# check column names
df = clean_names(df)
# list of response variables
rv_list = c("total_cell_number", "time_interval","n_cls")
rv_list = tolower(rv_list)
cv_list= c("sex", "age", "layer", "location")

cv_list[2]= "f.age"
cv_list[3]="f.layer"

# create a lite version including rv_list and cv_list
df_lite = df %>%
  filter(location != 4) %>%
  mutate (f.age = factor(age), f.layer = factor(layer))%>%
  select(subject_id, all_of(cv_list), all_of(rv_list))

```

```{r}
layer.label = c("Layer 2/3", "Layer 4")
names(layer.label) = c("2", "4")
sex.label = c("Female", "Male")
names(sex.label) = c("F", "M")
age.label = c("P11", "P13","P15", "P18", "P21")
names(age.label) = c("11", "13", "15", "18", "21")
```

```{r,fig.width = 8, fig.asp =0.2, echo=FALSE}
df_lite_fig = df_lite %>%
        select(subject_id,all_of(cv_list), total_cell_number,n_cls)%>%
        drop_na(n_cls) %>%
        tidyr::unite(col ="sex_layer", c("sex", "f.layer"), remove = FALSE)
 
ggplot(df_lite_fig,
    aes(x = n_cls, y = total_cell_number, color = sex_layer)) +
    geom_point(shape =1,alpha = 1)+
    facet_wrap(~f.age, ncol = 5, labeller = labeller(f.age = age.label), strip.position = "top") + 
    scale_x_continuous(breaks = c(1:5 * 5), limits =  c(0, 15)) +
    scale_y_continuous(breaks = c(1:6 * 100), limits =  c(0, 400)) +
    labs(x = "subnetwork #", y = "neuronal #") +
    theme(legend.text = element_text(color = "black", size  = "8"),
          legend.position = "right",
          legend.title = element_blank(),
          strip.placement = "outside",
          strip.text = element_text(color = "black", size  = "8"),
          strip.background = element_blank(),
          axis.text.x = element_text(color = "black", size = "8"),
          axis.line.x.bottom = element_line (linewidth = 1/4),
          axis.ticks.length.x = unit(-0.1, "cm"),
          axis.text.y = element_text(color = "black", size = "8"),
          axis.line.y = element_line(linewidth = 1/4),
          plot.background = element_blank(),
          plot.margin = unit(c(0,0,0,0), 'cm')) + 
   ggsci::scale_color_locuszoom() +
   annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf)
    
#ggsave("rr.svg", plot = last_plot(), path =here("output_plot"),
 #      width = 7.5, height = 1.5, units = "in")

```


```{r}
shapiro.test(df_lite_fig$n_cls)
shapiro.test(df_lite_fig$total_cell_number)
## when p-value < 0.05 --> data are not normal distributed
#if the data are not normally distributed, itâ€™s recommended to use the non-parametric correlation, including Spearman and Kendall rank-based correlation tests.
cor.test(df_lite_fig$n_cls, df_lite_fig$total_cell_number,
            method = "spearman")

```



### Figure Supp 4D - time vs subnetwork number
```{r,fig.width = 8, fig.asp =0.2, echo=FALSE}

df_lite_fig = df_lite %>%
        select(subject_id,all_of(cv_list), time_interval,n_cls)%>%
        drop_na(n_cls) %>%
        tidyr::unite(col ="sex_layer", c("sex", "f.layer"), remove = FALSE)
 
ggplot(df_lite_fig,
    aes(x = n_cls, y = time_interval, color = sex_layer)) +
    geom_point(shape =1,alpha = 1)+
    facet_wrap(~f.age, ncol = 5, labeller = labeller(f.age = age.label), strip.position = "top") + 
    scale_x_continuous(breaks = c(1:5 * 5), limits =  c(0, 15)) +
    scale_y_continuous(breaks = c(1:6 * 100), limits =  c(0, 300)) +
    labs(x = "subnetwork #", y = "time (s)") +
    theme(legend.text = element_text(color = "black", size  = "8"),
          legend.position = "right",
          legend.title = element_blank(),
          strip.placement = "outside",
          strip.text = element_text(color = "black", size  = "8"),
          strip.background = element_blank(),
          axis.text.x = element_text(color = "black", size = "8"),
          axis.line.x.bottom = element_line (linewidth = 1/4),
          axis.ticks.length.x = unit(-0.1, "cm"),
          axis.text.y = element_text(color = "black", size = "8"),
          axis.line.y = element_line(linewidth = 1/4),
          plot.background = element_blank(),
          plot.margin = unit(c(0,0,0,0), 'cm')) + 
   ggsci::scale_color_locuszoom() +
   annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf)
    
ggsave("rr.svg", plot = last_plot(), path =here("output_plot"),
       width = 7.5, height = 1.5, units = "in")

```


```{r}
shapiro.test(df_lite_fig$time_interval)
cor.test(df_lite_fig$n_cls, df_lite_fig$time_interval, method = "spearman")
```



### Figure Supp 4E - Kmean_CovM
```{r}
load (here("output","2023-02-19_SummaryDevAll_Kmean_CovM_withCorr_Dist_20230113.RData"))
```


```{r}
a <-plot_raw("cells_in_one_assembly",
         y_breaks = c(1:10 * 20), y_limits = c(0, 80),
        legend_position = "none", title = "Single-cluster (%)")

b <-plot_raw("cells_not_in_assembly",
         y_breaks = c(1:10 * 20), y_limits = c(0, 80),
        legend_position = "none",title = "Non-cluster (%)")

c <-plot_raw("cells_in_many_assembly",
         y_breaks = c(1:10 * 20), y_limits = c(0, 80),
        legend_position = "none", title = "Single-cluster (%)")

d <-plot_raw("cluster_r_all_mean",
         y_breaks = c(1:6 * 0.2), y_limits = c(0, 1),
                legend_position = "",title = "tCC in subnetwork")

```

```{r,fig.width = 8, fig.asp = 0.3, echo=FALSE}
ggarrange(a,b,c,d,
          ncol = 4, nrow = 1)
```

##### Figure Supp 4E - Kmean_CovM - Single-cluster
```{r}
report_main_effect("cells_in_one_assembly")
report_inter_age_sex_layer("cells_in_one_assembly")
```

##### Figure Supp 4E - Kmean_CovM - Non-cluster
```{r}
report_main_effect("cells_not_in_assembly")
report_inter_age_sex_layer("cells_not_in_assembly")
```

##### Figure Supp 4E - Kmean_CovM - Multiple-cluster
```{r}
report_main_effect("cells_in_many_assembly")
report_inter_age_sex_layer("cells_in_many_assembly")
```

##### Figure Supp 4E - Kmean_CovM - tCC in subnetwork
```{r}
report_main_effect("cluster_r_all_mean")
report_inter_age_sex_layer("cluster_r_all_mean")
```


### Figure Supp 4 - Community detection-uniform_CovM
```{r}
load (here("output","2023-02-19_SummaryDevAll_CommDetecUni_CovM_withCorrl_20230113.RData"))
```

```{r}
n <-plot_raw("cells_in_one_assembly",
         y_breaks = c(1:10 * 20), y_limits = c(0, 80),
        legend_position = "none", title = "Single-cluster (%)")

o <-plot_raw("cells_not_in_assembly",
         y_breaks = c(1:10 * 20), y_limits = c(0, 80),
        legend_position = "none",title = "Non-cluster (%)")

p <-plot_raw("cells_in_many_assembly",
         y_breaks = c(1:10 * 20), y_limits = c(0, 80),
        legend_position = "none", title = "Single-cluster (%)")

q <-plot_raw("cluster_r_all_mean",
         y_breaks = c(1:6 * 0.2), y_limits = c(0, 1),
                legend_position = "none",title = "tCC in subnetwork")

```

```{r,fig.width = 8, fig.asp = 0.3, echo=FALSE}
ggarrange(n,o,p,q,
          ncol = 4, nrow = 1)
```


##### Figure Supp 4E - Community detection-uniform - Single-cluster
```{r}
report_main_effect("cells_in_one_assembly")
report_inter_age_sex_layer("cells_in_one_assembly")
```

##### Figure Supp 4E - Community detection-uniform- Non-cluster
```{r}
report_main_effect("cells_not_in_assembly")
report_inter_age_sex_layer("cells_not_in_assembly")
```

##### Figure Supp 4E - Community detection-uniform- Multiple-cluster
```{r}
report_main_effect("cells_in_many_assembly")
report_inter_age_sex_layer("cells_in_many_assembly")
```

##### Figure Supp 4E - Community detection-uniform- tCC in subnetwork
```{r}
report_main_effect("cluster_r_all_mean")
report_inter_age_sex_layer("cluster_r_all_mean")
```



### Figure Supp 4E - Community detection-Asymmetric_CovM
```{r}
load (here("output","2023-02-19_SummaryDevAll_CommDetecAsy_CovM_withCorr_20230113.RData"))
```

```{r}
r <-plot_raw("cells_in_one_assembly",
         y_breaks = c(1:10 * 20), y_limits = c(0, 80),
        legend_position = "none", title = "Single-cluster (%)")

s <-plot_raw("cells_not_in_assembly",
         y_breaks = c(1:10 * 20), y_limits = c(0, 80),
        legend_position = "none",title = "Non-cluster (%)")

t <-plot_raw("cells_in_many_assembly",
         y_breaks = c(1:10 * 20), y_limits = c(0, 80),
        legend_position = "none", title = "Single-cluster (%)")

u <-plot_raw("cluster_r_all_mean",
         y_breaks = c(1:6 * 0.2), y_limits = c(0, 1),
                legend_position = "none",title = "tCC in subnetwork")

```

```{r,fig.width = 8, fig.asp = 0.3, echo=FALSE}
ggarrange(r,s,t,u,
          ncol = 4, nrow = 1)
```


##### Figure Supp 4E - Community detection-Asymmetric_CovM - Single-cluster
```{r}
report_main_effect("cells_in_one_assembly")
report_inter_age_sex_layer("cells_in_one_assembly")
```

##### Figure Supp 4E - Community detection-Asymmetric_CovM - Non-cluster
```{r}
report_main_effect("cells_not_in_assembly")
report_inter_age_sex_layer("cells_not_in_assembly")
```

##### Figure Supp 4E - Community detection-Asymmetric_CovM - Multiple-cluster
```{r}
report_main_effect("cells_in_many_assembly")
report_inter_age_sex_layer("cells_in_many_assembly")
```

##### Figure Supp 4E - Community detection-Asymmetric_CovM - tCC in subnetwork
```{r}
report_main_effect("cluster_r_all_mean")
report_inter_age_sex_layer("cluster_r_all_mean")
```

